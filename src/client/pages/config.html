<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Config
    </title>

</head>
<body>
    <h1>CONFIG PAGE :)</h1>
    <p>Choose tab1 or tab2 you want</p>
    <button id = 'tab1-btn'>Tab 1</button>
    <button id = 'tab2-btn'>Tab 2</button>
</body>
</html>

<script 
src="https://res.cdn.office.net/teams-js/2.10.1/js/MicrosoftTeams.min.js"
integrity="sha384-Tc1x2xjzm4vRqLV4l416qPm+i7t8ujpxrioZEjRCNP7g/gQNDW41TB1SpVkQxowY"
crossorigin="anonymous"
></script>

<script src="scripts/teams/constants.js"></script>

<script type = 'module'>

    await microsoftTeams.app.initialize()
    console.log('HELLO WORLD')

    function setTheme(theme) {
        if (theme) {        
            document.body.className =
                'theme-' + (theme === 'default' ? 'light' : theme);
        }
    }

    microsoftTeams.getContext(function (context) {
        if (context && context.theme) {
            setTheme(context.theme);
        }
    });
    
    microsoftTeams.registerOnThemeChangeHandler(function (theme) {
        setTheme(theme);
    });

    const registerConfig = async(url) => {
        microsoftTeams.pages.config.setValidityState(true)

        await saveCreatorInLocal()

        microsoftTeams.pages.config.registerOnSaveHandler((saveEvent) => {
            const configPromise = microsoftTeams.pages.config.setConfig({
                websiteUrl:url,
                contentUrl:url,
                entityId:url
            })

            const serverPromise = fetch(
                'api/demo/getConfig',{
                    method: 'POST',
                    headers: {
                        'Content-Type' : 'application/json'
                    },
                    body: JSON.stringify({type: "page1"})
                }                
            )
            
            configPromise.then((result) => {
                saveEvent.notifySuccess()
            }).catch(error => {
                console.log(error)
                saveEvent.notifyFailure('Fail occured ;/', error)
            })

            serverPromise.then(data =>{
                saveEvent.notifySuccess()
            }).catch(error => {
                console.log('error', error)
                saveEvent.notifyFailure('Issue: ', error)
            })

        })
    }

    const saveCreatorInLocal = async() => {
        const context = await microsoftTeams.app.getContext()
        console.log('saving creator in localstorage')
        localStorage.setItem('creator', context.user.userPrincipalName)
    }

    const page1 = () => {

        const configPageUrl = `${srcUrl}/page1`
        
        saveCreatorInLocal()

        registerConfig(configPageUrl)
    }

    const page2 = () => {
        const configPageUrl = `${srcUrl}/page2`
        
        saveCreatorInLocal()

        registerConfig(configPageUrl)
    }

    document.getElementById('tab1-btn').addEventListener('click', page1)
    document.getElementById('tab2-btn').addEventListener('click', page2)
</script>